{"version":3,"sources":["../../src/transport/websocket.ts"],"names":[],"mappings":"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","file":"websocket.js","sourcesContent":["/**\n * @file transport/websocket.ts\n * @description WebSocket transport for HxTP client.\n * Works in Browser, Node.js 18+ (built-in WebSocket), Bun, Deno, React Native.\n *\n * Copyright (c) 2026 Hestia Labs\n * SDK-License-Identifier: MIT\n */\n\nimport type { Transport, TransportState } from \"./interface.js\";\n\nexport type { Transport, TransportState } from \"./interface.js\";\n\nexport interface WebSocketTransportOptions {\n    /** WebSocket server URL (ws:// or wss://). */\n    readonly url: string;\n\n    /** Authentication token sent as query param. */\n    readonly token?: string;\n\n    /** Custom WebSocket protocols. */\n    readonly protocols?: string | string[];\n\n    /** Connection timeout in ms (default: 10000). */\n    readonly connectTimeoutMs?: number;\n}\n\n/**\n * WebSocket transport implementation.\n *\n * Uses the global `WebSocket` constructor available in:\n *   - All modern browsers\n *   - Node.js 21+ (global WebSocket)\n *   - Bun (global WebSocket)\n *   - Deno (global WebSocket)\n *   - React Native (global WebSocket)\n *\n * For Node.js 18-20, pass a WebSocket constructor via\n * `globalThis.WebSocket = require('ws')` or use Node 21+.\n */\nexport class WebSocketTransport implements Transport {\n    private socket: WebSocket | null = null;\n    private messageHandlers: Array<(data: string) => void> = [];\n    private closeHandlers: Array<(code: number, reason: string) => void> = [];\n    private errorHandlers: Array<(error: Error) => void> = [];\n    private _state: TransportState = \"disconnected\";\n\n    private readonly url: string;\n    private readonly protocols?: string | string[];\n    private readonly connectTimeoutMs: number;\n\n    constructor(opts: WebSocketTransportOptions) {\n        let url = opts.url;\n        if (opts.token) {\n            const sep = url.includes(\"?\") ? \"&\" : \"?\";\n            url = `${url}${sep}token=${encodeURIComponent(opts.token)}`;\n        }\n        this.url = url;\n        this.protocols = opts.protocols;\n        this.connectTimeoutMs = opts.connectTimeoutMs ?? 10_000;\n    }\n\n    get state(): TransportState {\n        return this._state;\n    }\n\n    async connect(): Promise<void> {\n        if (this._state === \"connected\") return;\n\n        this._state = \"connecting\";\n\n        return new Promise<void>((resolve, reject) => {\n            const WS = resolveWebSocket();\n            const socket = new WS(this.url, this.protocols);\n            this.socket = socket;\n\n            const timeout = setTimeout(() => {\n                socket.close();\n                this._state = \"disconnected\";\n                reject(\n                    new Error(`WebSocket connection timed out after ${this.connectTimeoutMs}ms`),\n                );\n            }, this.connectTimeoutMs);\n\n            socket.onopen = () => {\n                clearTimeout(timeout);\n                this._state = \"connected\";\n                resolve();\n            };\n\n            socket.onmessage = (event: MessageEvent) => {\n                const data = typeof event.data === \"string\" ? event.data : String(event.data);\n                for (const handler of this.messageHandlers) {\n                    handler(data);\n                }\n            };\n\n            socket.onclose = (event: CloseEvent) => {\n                clearTimeout(timeout);\n                this._state = \"disconnected\";\n                this.socket = null;\n                for (const handler of this.closeHandlers) {\n                    handler(event.code, event.reason);\n                }\n            };\n\n            socket.onerror = () => {\n                clearTimeout(timeout);\n                const err = new Error(\"WebSocket connection error\");\n                for (const handler of this.errorHandlers) {\n                    handler(err);\n                }\n                if (this._state === \"connecting\") {\n                    this._state = \"disconnected\";\n                    reject(err);\n                }\n            };\n        });\n    }\n\n    async disconnect(): Promise<void> {\n        if (!this.socket) return;\n        this.socket.close(1000, \"Client disconnect\");\n        this.socket = null;\n        this._state = \"disconnected\";\n    }\n\n    async send(data: string): Promise<void> {\n        if (!this.socket || this._state !== \"connected\") {\n            throw new Error(\"WebSocket not connected\");\n        }\n        this.socket.send(data);\n    }\n\n    onMessage(handler: (data: string) => void): void {\n        this.messageHandlers.push(handler);\n    }\n\n    onClose(handler: (code: number, reason: string) => void): void {\n        this.closeHandlers.push(handler);\n    }\n\n    onError(handler: (error: Error) => void): void {\n        this.errorHandlers.push(handler);\n    }\n}\n\n/**\n * Resolve the WebSocket constructor from the global scope.\n */\nfunction resolveWebSocket(): typeof WebSocket {\n    if (typeof globalThis.WebSocket !== \"undefined\") {\n        return globalThis.WebSocket;\n    }\n    throw new Error(\n        \"WebSocket not available. For Node.js 18-20, set globalThis.WebSocket \" +\n            \"to a WebSocket implementation (e.g., 'ws' package). Node.js 21+ has built-in WebSocket.\",\n    );\n}\n"]}