{"version":3,"sources":["../src/crypto/interface.ts","../src/crypto/node.ts","../src/crypto/web.ts","../src/types/protocol.ts","../src/core/signing.ts","../src/core/canonical.ts","../src/core/nonce.ts","../src/core/envelope.ts","../src/core/validation.ts","../src/crypto/detect.ts","../src/transport/websocket.ts","../src/core/client.ts","../src/core/topics.ts","../src/index.ts"],"names":["generateNonce","timingSafeEqual","nodeRandomBytes","createHmac","createHash"],"mappings":"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","file":"index.cjs","sourcesContent":["/**\n * @file crypto/interface.ts\n * @description Unified crypto provider interface.\n * Implementations: node.ts (Node/Bun/Deno), web.ts (Browser/React Native).\n *\n * Copyright (c) 2026 Hestia Labs\n * SDK-License-Identifier: MIT\n */\n\nexport interface CryptoProvider {\n    /**\n     * Compute HMAC-SHA256 and return lowercase hex string (64 chars).\n     * @param secret - Raw secret bytes.\n     * @param data - UTF-8 string to sign.\n     */\n    signHmacSha256(secret: Uint8Array, data: string): Promise<string>;\n\n    /**\n     * Compute SHA-256 hash and return lowercase hex string (64 chars).\n     * @param data - UTF-8 string to hash.\n     */\n    sha256Hex(data: string): Promise<string>;\n\n    /**\n     * Generate cryptographically secure random bytes.\n     * @param length - Number of bytes.\n     */\n    randomBytes(length: number): Uint8Array;\n}\n\n/**\n * Constant-time string comparison.\n * Safe for comparing HMAC hex digests — prevents timing side-channels.\n * Platform-independent: does NOT rely on crypto.timingSafeEqual.\n */\nexport function constantTimeEqual(a: string, b: string): boolean {\n    if (a.length !== b.length) return false;\n\n    let diff = 0;\n    for (let i = 0; i < a.length; i++) {\n        diff |= a.charCodeAt(i) ^ b.charCodeAt(i);\n    }\n    return diff === 0;\n}\n\n/** Convert Uint8Array to lowercase hex string. */\nexport function bytesToHex(bytes: Uint8Array): string {\n    const hex: string[] = [];\n    for (let i = 0; i < bytes.length; i++) {\n        hex.push((bytes[i]! >>> 4).toString(16));\n        hex.push((bytes[i]! & 0x0f).toString(16));\n    }\n    return hex.join(\"\");\n}\n\n/** Convert hex string to Uint8Array. */\nexport function hexToBytes(hex: string): Uint8Array {\n    if (hex.length % 2 !== 0) {\n        throw new Error(\"Invalid hex string length\");\n    }\n    const bytes = new Uint8Array(hex.length / 2);\n    for (let i = 0; i < hex.length; i += 2) {\n        bytes[i / 2] = parseInt(hex.substring(i, i + 2), 16);\n    }\n    return bytes;\n}\n","/**\n * @file crypto/node.ts\n * @description Node.js / Bun / Deno crypto provider using native `node:crypto`.\n *\n * Copyright (c) 2026 Hestia Labs\n * SDK-License-Identifier: MIT\n */\n\nimport {\n    createHmac,\n    createHash,\n    randomBytes as nodeRandomBytes,\n    timingSafeEqual,\n} from \"node:crypto\";\nimport type { CryptoProvider } from \"./interface.js\";\nimport { bytesToHex } from \"./interface.js\";\n\nexport { constantTimeEqual, hexToBytes, bytesToHex } from \"./interface.js\";\n\nclass NodeCryptoProvider implements CryptoProvider {\n    async signHmacSha256(secret: Uint8Array, data: string): Promise<string> {\n        const hmac = createHmac(\"sha256\", secret);\n        hmac.update(data, \"utf8\");\n        return hmac.digest(\"hex\");\n    }\n\n    async sha256Hex(data: string): Promise<string> {\n        const hash = createHash(\"sha256\");\n        hash.update(data, \"utf8\");\n        return hash.digest(\"hex\");\n    }\n\n    randomBytes(length: number): Uint8Array {\n        return new Uint8Array(nodeRandomBytes(length));\n    }\n}\n\n/** Singleton Node.js crypto provider. */\nexport const nodeCrypto: CryptoProvider = new NodeCryptoProvider();\n\n/**\n * Constant-time comparison using Node.js `timingSafeEqual`.\n * Preferred over the platform-agnostic version when available.\n * Uses static ESM import — no CJS require() leakage.\n */\nexport function nodeConstantTimeEqual(a: string, b: string): boolean {\n    if (a.length !== b.length) return false;\n    return timingSafeEqual(Buffer.from(a, \"utf8\"), Buffer.from(b, \"utf8\"));\n}\n\n/**\n * Generate a nonce as hex string (min 16 raw bytes → 32 hex chars).\n */\nexport function generateNonce(byteLength: number = 16): string {\n    const bytes = nodeRandomBytes(byteLength);\n    return bytesToHex(new Uint8Array(bytes));\n}\n","/**\n * @file crypto/web.ts\n * @description Browser / React Native crypto provider using Web Crypto API.\n * Works in all environments with `crypto.subtle` (browsers, Expo, Deno).\n *\n * Copyright (c) 2026 Hestia Labs\n * SDK-License-Identifier: MIT\n */\n\nimport type { CryptoProvider } from \"./interface.js\";\nimport { bytesToHex } from \"./interface.js\";\n\nexport { constantTimeEqual, hexToBytes, bytesToHex } from \"./interface.js\";\n\n/** Resolve the global crypto object across environments. */\nfunction getSubtle(): SubtleCrypto {\n    if (typeof globalThis.crypto?.subtle !== \"undefined\") {\n        return globalThis.crypto.subtle;\n    }\n    throw new Error(\"Web Crypto API not available. Use hxtp-js/crypto/node for Node.js.\");\n}\n\n/** Resolve the global crypto for randomness. */\nfunction getCrypto(): Crypto {\n    if (typeof globalThis.crypto !== \"undefined\") {\n        return globalThis.crypto;\n    }\n    throw new Error(\"crypto.getRandomValues not available in this environment.\");\n}\n\nconst encoder = new TextEncoder();\n\nclass WebCryptoProvider implements CryptoProvider {\n    async signHmacSha256(secret: Uint8Array, data: string): Promise<string> {\n        const subtle = getSubtle();\n        const key = await subtle.importKey(\n            \"raw\",\n            secret.buffer as ArrayBuffer,\n            { name: \"HMAC\", hash: \"SHA-256\" },\n            false,\n            [\"sign\"],\n        );\n        const sig = await subtle.sign(\"HMAC\", key, encoder.encode(data));\n        return bytesToHex(new Uint8Array(sig));\n    }\n\n    async sha256Hex(data: string): Promise<string> {\n        const subtle = getSubtle();\n        const digest = await subtle.digest(\"SHA-256\", encoder.encode(data));\n        return bytesToHex(new Uint8Array(digest));\n    }\n\n    randomBytes(length: number): Uint8Array {\n        const buf = new Uint8Array(length);\n        getCrypto().getRandomValues(buf);\n        return buf;\n    }\n}\n\n/** Singleton Web Crypto provider. */\nexport const webCrypto: CryptoProvider = new WebCryptoProvider();\n\n/**\n * Generate a nonce as hex string using Web Crypto.\n */\nexport function generateNonce(byteLength: number = 16): string {\n    const bytes = new Uint8Array(byteLength);\n    getCrypto().getRandomValues(bytes);\n    return bytesToHex(bytes);\n}\n","/**\n * @file types/protocol.ts\n * @description HxTP/2.2 protocol type definitions.\n * All types are frozen and aligned with embedded SDK v1.0 + backend.\n *\n * Copyright (c) 2026 Hestia Labs\n * SDK-License-Identifier: MIT\n */\n\n/* ── Protocol Constants (FROZEN) ─────────────────────────────────────── */\n\nexport const PROTOCOL_VERSION = \"HxTP/2.2\" as const;\nexport const CANONICAL_SEPARATOR = \"|\" as const;\nexport const MAX_MESSAGE_AGE_SEC = 300;\nexport const TIMESTAMP_SKEW_SEC = 60;\nexport const NONCE_TTL_SEC = 600;\nexport const MAX_PAYLOAD_BYTES = 16_384;\nexport const HMAC_HEX_LENGTH = 64;\nexport const SHA256_HEX_LENGTH = 64;\nexport const MIN_NONCE_BYTES = 16;\n\n/* ── Message Types ───────────────────────────────────────────────────── */\n\nexport const MessageType = {\n    STATE: \"state\",\n    COMMAND: \"command\",\n    HEARTBEAT: \"heartbeat\",\n    TELEMETRY: \"telemetry\",\n    OTA: \"ota\",\n    ACK: \"ack\",\n    ERROR: \"error\",\n} as const;\n\nexport type MessageTypeValue = (typeof MessageType)[keyof typeof MessageType];\n\n/* ── MQTT Topic Channels ─────────────────────────────────────────────── */\n\nexport const Channel = {\n    STATE: \"state\",\n    CMD: \"cmd\",\n    CMD_ACK: \"cmd_ack\",\n    HELLO: \"hello\",\n    HEARTBEAT: \"heartbeat\",\n    OTA: \"ota\",\n    OTA_STATUS: \"ota_status\",\n    TELEMETRY: \"telemetry\",\n} as const;\n\nexport type ChannelValue = (typeof Channel)[keyof typeof Channel];\n\n/* ── Message Header ──────────────────────────────────────────────────── */\n\nexport interface HXTPMessageHeader {\n    readonly version: string;\n    readonly message_type: MessageTypeValue;\n    readonly message_id: string;\n    readonly device_id: string;\n    readonly tenant_id: string;\n    readonly client_id?: string;\n    readonly timestamp: number;\n    readonly sequence_number?: number;\n    readonly nonce: string;\n    readonly payload_hash: string;\n    readonly signature: string;\n}\n\n/* ── Outbound Envelope (pre-signature) ───────────────────────────────── */\n\nexport interface HXTPEnvelope {\n    readonly version: string;\n    readonly message_type: MessageTypeValue;\n    readonly message_id: string;\n    readonly device_id: string;\n    readonly tenant_id: string;\n    readonly client_id?: string;\n    readonly timestamp: number;\n    readonly sequence_number?: number;\n    readonly nonce: string;\n    readonly payload_hash: string;\n    readonly signature: string;\n    readonly params?: Record<string, unknown>;\n    readonly [key: string]: unknown;\n}\n\n/* ── Validation Result ───────────────────────────────────────────────── */\n\nexport interface ValidationResult {\n    readonly ok: boolean;\n    readonly code: string;\n    readonly reason: string;\n    readonly rotated: boolean;\n}\n\n/* ── Validation Step Enum ────────────────────────────────────────────── */\n\nexport const ValidationStep = {\n    VERSION: \"VERSION_CHECK\",\n    TIMESTAMP: \"TIMESTAMP_CHECK\",\n    PAYLOAD_SIZE: \"PAYLOAD_SIZE_CHECK\",\n    NONCE: \"NONCE_CHECK\",\n    PAYLOAD_HASH: \"PAYLOAD_HASH_CHECK\",\n    SEQUENCE: \"SEQUENCE_CHECK\",\n    SIGNATURE: \"SIGNATURE_CHECK\",\n} as const;\n\n/* ── Protocol Errors ─────────────────────────────────────────────────── */\n\nexport const ProtocolError = {\n    VERSION_MISMATCH: \"VERSION_MISMATCH\",\n    TIMESTAMP_EXPIRED: \"TIMESTAMP_EXPIRED\",\n    TIMESTAMP_FUTURE: \"TIMESTAMP_FUTURE\",\n    PAYLOAD_TOO_LARGE: \"PAYLOAD_TOO_LARGE\",\n    NONCE_MISSING: \"NONCE_MISSING\",\n    NONCE_REUSED: \"NONCE_REUSED\",\n    HASH_MISMATCH: \"HASH_MISMATCH\",\n    SEQUENCE_VIOLATION: \"SEQUENCE_VIOLATION\",\n    SIGNATURE_MISSING: \"SIGNATURE_MISSING\",\n    SIGNATURE_INVALID: \"SIGNATURE_INVALID\",\n    SECRET_MISSING: \"SECRET_MISSING\",\n} as const;\n\nexport type ProtocolErrorCode = (typeof ProtocolError)[keyof typeof ProtocolError];\n","/**\n * @file core/signing.ts\n * @description HMAC-SHA256 message signing and verification.\n * Matches backend SecurityModule.ts and embedded Core.cpp signing logic.\n *\n * Copyright (c) 2026 Hestia Labs\n * SDK-License-Identifier: MIT\n */\n\nimport type { CryptoProvider } from \"../crypto/interface.js\";\nimport { constantTimeEqual, hexToBytes } from \"../crypto/interface.js\";\nimport { buildCanonical } from \"./canonical.js\";\nimport { HMAC_HEX_LENGTH } from \"../types/protocol.js\";\n\ninterface SignableMessage {\n    readonly version: string;\n    readonly message_type: string;\n    readonly device_id: string;\n    readonly tenant_id: string;\n    readonly timestamp: number;\n    readonly message_id: string;\n    readonly nonce: string;\n    readonly [key: string]: unknown;\n}\n\n/**\n * Sign a message with HMAC-SHA256 over the canonical string.\n *\n * @param crypto - Crypto provider.\n * @param secretHex - 64-char hex-encoded shared secret.\n * @param msg - Message fields for canonical string construction.\n * @returns 64-char lowercase hex HMAC-SHA256 signature.\n */\nexport async function signMessage(\n    crypto: CryptoProvider,\n    secretHex: string,\n    msg: SignableMessage,\n): Promise<string> {\n    if (!secretHex || secretHex.length !== 64) {\n        throw new Error(\"Secret must be a 64-character hex string (32 bytes).\");\n    }\n\n    const secretBytes = hexToBytes(secretHex);\n    const canonical = buildCanonical(msg);\n    return crypto.signHmacSha256(secretBytes, canonical);\n}\n\n/**\n * Verify a message signature using the active secret.\n *\n * @returns `true` if signature is valid, `false` otherwise.\n */\nexport async function verifySignature(\n    crypto: CryptoProvider,\n    secretHex: string,\n    msg: SignableMessage,\n    signature: string,\n): Promise<boolean> {\n    if (!signature || signature.length !== HMAC_HEX_LENGTH) return false;\n    if (!secretHex) return false;\n\n    const computed = await signMessage(crypto, secretHex, msg);\n    return constantTimeEqual(computed, signature);\n}\n\n/**\n * Verify with dual-key fallback for key rotation windows.\n * Mirrors backend `VerifySignatureWithFallback`.\n *\n * @returns `{ valid, rotated }` — rotated=true means previous key matched.\n */\nexport async function verifySignatureWithFallback(\n    crypto: CryptoProvider,\n    activeSecretHex: string,\n    previousSecretHex: string | undefined,\n    msg: SignableMessage,\n    signature: string,\n): Promise<{ valid: boolean; rotated: boolean }> {\n    const activeValid = await verifySignature(crypto, activeSecretHex, msg, signature);\n\n    if (activeValid) {\n        return { valid: true, rotated: false };\n    }\n\n    if (previousSecretHex) {\n        const prevValid = await verifySignature(crypto, previousSecretHex, msg, signature);\n\n        if (prevValid) {\n            return { valid: true, rotated: true };\n        }\n    }\n\n    return { valid: false, rotated: false };\n}\n","/**\n * @file core/canonical.ts\n * @description FROZEN canonical string builder for HxTP message signatures.\n *\n * Format: version|message_type|device_id|tenant_id|timestamp|message_id|nonce\n *\n * This format is FROZEN. Any change invalidates ALL signatures across\n * all deployed devices (embedded, backend, and client SDKs).\n *\n * Matches:\n *   - Backend:  src/protocol/Canonical.ts  → BuildCanonical()\n *   - Embedded: lib/HXTP/src/Validation.cpp → build_canonical_string()\n *\n * Copyright (c) 2026 Hestia Labs\n * SDK-License-Identifier: MIT\n */\n\nimport { CANONICAL_SEPARATOR } from \"../types/protocol.js\";\n\ninterface CanonicalFields {\n    readonly version?: string;\n    readonly protocol_version?: string;\n    readonly message_type?: string;\n    readonly device_id?: string;\n    readonly tenant_id?: string;\n    readonly timestamp?: number | string;\n    readonly message_id?: string;\n    readonly nonce?: string;\n    readonly [key: string]: unknown;\n}\n\n/**\n * Build a canonical string from a message object.\n *\n * FROZEN FORMAT — DO NOT MODIFY.\n *\n * Uses `String()` coercion to match backend behavior exactly:\n *   String(Msg.version), String(Msg.message_type), ...\n *\n * The embedded SDK uses `snprintf(\"%lld\", timestamp)` which produces\n * the same decimal representation as `String(timestamp)` in JS.\n */\nexport function buildCanonical(msg: CanonicalFields): string {\n    const parts: string[] = [\n        String(msg.version || msg.protocol_version || \"\"),\n        String(msg.message_type || \"\"),\n        String(msg.device_id || \"\"),\n        String(msg.tenant_id || \"\"),\n        String(msg.timestamp || \"\"),\n        String(msg.message_id || \"\"),\n        String(msg.nonce || \"\"),\n    ];\n    return parts.join(CANONICAL_SEPARATOR);\n}\n\n/**\n * Parse a canonical string back into named components.\n */\nexport function parseCanonical(canonical: string): Record<string, string> {\n    const parts = canonical.split(CANONICAL_SEPARATOR);\n    return {\n        version: parts[0] || \"\",\n        message_type: parts[1] || \"\",\n        device_id: parts[2] || \"\",\n        tenant_id: parts[3] || \"\",\n        timestamp: parts[4] || \"\",\n        message_id: parts[5] || \"\",\n        nonce: parts[6] || \"\",\n    };\n}\n\n/**\n * Validate that a canonical string has exactly 7 non-empty fields.\n */\nexport function validateCanonical(canonical: string): boolean {\n    const parts = canonical.split(CANONICAL_SEPARATOR);\n    return parts.length === 7 && parts.every((p) => p.length > 0);\n}\n","/**\n * @file core/nonce.ts\n * @description Nonce generation and replay cache.\n * Nonces are hex-encoded random bytes (min 16 bytes → 32 hex chars).\n *\n * Copyright (c) 2026 Hestia Labs\n * SDK-License-Identifier: MIT\n */\n\nimport type { CryptoProvider } from \"../crypto/interface.js\";\nimport { bytesToHex } from \"../crypto/interface.js\";\nimport { MIN_NONCE_BYTES, NONCE_TTL_SEC } from \"../types/protocol.js\";\n\n/**\n * Generate a cryptographic nonce as hex string.\n * Minimum 16 raw bytes → 32 hex characters.\n */\nexport function generateNonce(\n    crypto: CryptoProvider,\n    byteLength: number = MIN_NONCE_BYTES,\n): string {\n    if (byteLength < MIN_NONCE_BYTES) {\n        throw new Error(`Nonce must be >= ${MIN_NONCE_BYTES} bytes.`);\n    }\n    return bytesToHex(crypto.randomBytes(byteLength));\n}\n\n/* ── Replay Cache ────────────────────────────────────────────────────── */\n\ninterface NonceEntry {\n    readonly nonce: string;\n    readonly timestampMs: number;\n}\n\n/**\n * In-memory nonce replay cache with TTL eviction.\n * Suitable for Node.js long-lived processes.\n * Not suitable for stateless browser tabs (disable via config).\n */\nexport class NonceCache {\n    private readonly entries: NonceEntry[] = [];\n    private readonly maxSize: number;\n    private readonly ttlMs: number;\n\n    constructor(maxSize: number = 256, ttlSec: number = NONCE_TTL_SEC) {\n        this.maxSize = maxSize;\n        this.ttlMs = ttlSec * 1000;\n    }\n\n    /**\n     * Check if a nonce has been seen. Returns `true` if duplicate (replay).\n     * Automatically records the nonce if new.\n     */\n    check(nonce: string): boolean {\n        const now = Date.now();\n        this.evict(now);\n\n        for (const entry of this.entries) {\n            if (entry.nonce === nonce) return true;\n        }\n\n        this.entries.push({ nonce, timestampMs: now });\n\n        if (this.entries.length > this.maxSize) {\n            this.entries.shift();\n        }\n\n        return false;\n    }\n\n    /** Remove expired entries. */\n    private evict(now: number): void {\n        while (this.entries.length > 0 && now - this.entries[0]!.timestampMs > this.ttlMs) {\n            this.entries.shift();\n        }\n    }\n\n    /** Clear all entries. */\n    clear(): void {\n        this.entries.length = 0;\n    }\n\n    /** Current cache size. */\n    get size(): number {\n        return this.entries.length;\n    }\n}\n","/**\n * @file core/envelope.ts\n * @description Constructs signed HxTP message envelopes.\n * Matches backend CommandEngine.ts and embedded Core.cpp build logic.\n *\n * Copyright (c) 2026 Hestia Labs\n * SDK-License-Identifier: MIT\n */\n\nimport type { CryptoProvider } from \"../crypto/interface.js\";\nimport type { HXTPEnvelope, MessageTypeValue } from \"../types/protocol.js\";\nimport { PROTOCOL_VERSION } from \"../types/protocol.js\";\nimport { signMessage } from \"./signing.js\";\nimport { generateNonce } from \"./nonce.js\";\nimport { bytesToHex } from \"../crypto/interface.js\";\n\ninterface EnvelopeParams {\n    readonly crypto: CryptoProvider;\n    readonly secretHex: string;\n    readonly deviceId: string;\n    readonly tenantId: string;\n    readonly clientId?: string;\n    readonly messageType: MessageTypeValue;\n    readonly params?: Record<string, unknown>;\n    readonly sequence?: number;\n}\n\n/**\n * Build a fully signed HxTP envelope ready for transmission.\n *\n * Steps:\n *   1. Generate message_id (UUID v4 via random bytes)\n *   2. Generate nonce (16 random bytes, hex-encoded)\n *   3. Compute payload_hash (SHA-256 of JSON.stringify(params))\n *   4. Build canonical string\n *   5. Compute HMAC-SHA256 signature\n *   6. Return complete envelope\n */\nexport async function buildEnvelope(opts: EnvelopeParams): Promise<HXTPEnvelope> {\n    const { crypto, secretHex, deviceId, tenantId, messageType, params } = opts;\n\n    if (!secretHex || secretHex.length !== 64) {\n        throw new Error(\"Secret must be a 64-character hex string (32 bytes).\");\n    }\n\n    const messageId = generateUUID(crypto);\n    const nonce = generateNonce(crypto);\n    const timestamp = Date.now();\n\n    const paramsJson = JSON.stringify(params ?? {});\n    const payloadHash = await crypto.sha256Hex(paramsJson);\n\n    const msgFields = {\n        version: PROTOCOL_VERSION,\n        message_type: messageType,\n        device_id: deviceId,\n        tenant_id: tenantId,\n        timestamp,\n        message_id: messageId,\n        nonce,\n    };\n\n    const signature = await signMessage(crypto, secretHex, msgFields);\n\n    return {\n        ...msgFields,\n        client_id: opts.clientId,\n        sequence_number: opts.sequence,\n        payload_hash: payloadHash,\n        signature,\n        params,\n    };\n}\n\n/**\n * Generate a UUID v4 string from random bytes.\n * Format: xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx\n */\nfunction generateUUID(crypto: CryptoProvider): string {\n    const bytes = crypto.randomBytes(16);\n\n    /* Set version (4) and variant (10xx) bits per RFC 4122 */\n    bytes[6] = (bytes[6]! & 0x0f) | 0x40;\n    bytes[8] = (bytes[8]! & 0x3f) | 0x80;\n\n    const hex = bytesToHex(bytes);\n    return [\n        hex.substring(0, 8),\n        hex.substring(8, 12),\n        hex.substring(12, 16),\n        hex.substring(16, 20),\n        hex.substring(20, 32),\n    ].join(\"-\");\n}\n","/**\n * @file core/validation.ts\n * @description Client-side validation pipeline.\n * Mirrors the 7-step server pipeline where applicable on the client.\n *\n * Server pipeline:\n *   1. Version → 2. Timestamp → 3. Nonce → 4. PayloadHash →\n *   5. Sequence → 6. Signature (with dual-key fallback)\n *\n * Embedded pipeline (superset):\n *   1. Version → 2. Timestamp → 3. PayloadSize → 4. Nonce →\n *   5. PayloadHash → 6. Sequence → 7. Signature\n *\n * Client-side validates inbound messages (from server → client):\n *   1. Version       — matches PROTOCOL_VERSION\n *   2. Timestamp     — within MAX_MESSAGE_AGE_SEC + TIMESTAMP_SKEW_SEC\n *   3. PayloadSize   — within MAX_PAYLOAD_BYTES\n *   4. Nonce         — non-empty; optionally checked against replay cache\n *   5. PayloadHash   — SHA-256 of params matches header\n *   6. Signature     — HMAC-SHA256 with dual-key fallback\n *\n * Copyright (c) 2026 Hestia Labs\n * SDK-License-Identifier: MIT\n */\n\nimport type { CryptoProvider } from \"../crypto/interface.js\";\nimport type { ValidationResult } from \"../types/protocol.js\";\nimport {\n    PROTOCOL_VERSION,\n    MAX_MESSAGE_AGE_SEC,\n    TIMESTAMP_SKEW_SEC,\n    MAX_PAYLOAD_BYTES,\n    ProtocolError,\n} from \"../types/protocol.js\";\nimport { verifySignatureWithFallback } from \"./signing.js\";\nimport type { NonceCache } from \"./nonce.js\";\n\ninterface ValidatableMessage {\n    readonly version?: string;\n    readonly protocol_version?: string;\n    readonly message_type?: string;\n    readonly device_id?: string;\n    readonly tenant_id?: string;\n    readonly timestamp?: number;\n    readonly message_id?: string;\n    readonly nonce?: string;\n    readonly payload_hash?: string;\n    readonly signature?: string;\n    readonly params?: Record<string, unknown>;\n    readonly [key: string]: unknown;\n}\n\ninterface ValidationOptions {\n    readonly crypto: CryptoProvider;\n    readonly activeSecret: string;\n    readonly previousSecret?: string;\n    readonly nonceCache?: NonceCache;\n    readonly maxMessageAgeSec?: number;\n    readonly timestampSkewSec?: number;\n    readonly nowMs?: number;\n}\n\nfunction pass(): ValidationResult {\n    return { ok: true, code: \"\", reason: \"\", rotated: false };\n}\n\nfunction fail(code: string, reason: string): ValidationResult {\n    return { ok: false, code, reason, rotated: false };\n}\n\n/**\n * Validate an inbound message through the client-side pipeline.\n */\nexport async function validateMessage(\n    msg: ValidatableMessage,\n    opts: ValidationOptions,\n): Promise<ValidationResult> {\n    const maxAge = opts.maxMessageAgeSec ?? MAX_MESSAGE_AGE_SEC;\n    const skew = opts.timestampSkewSec ?? TIMESTAMP_SKEW_SEC;\n    const now = opts.nowMs ?? Date.now();\n\n    /* ── 1. Version ──────────────────────────────────────── */\n    const version = msg.version || msg.protocol_version || \"\";\n    if (version !== PROTOCOL_VERSION) {\n        return fail(ProtocolError.VERSION_MISMATCH, `Unsupported version: ${version}`);\n    }\n\n    /* ── 2. Timestamp Freshness ──────────────────────────── */\n    const ts = typeof msg.timestamp === \"number\" ? msg.timestamp : 0;\n    const nowSec = Math.floor(now / 1000);\n\n    let tsSec = ts;\n    if (ts > 1_000_000_000_000) {\n        tsSec = Math.floor(ts / 1000);\n    }\n\n    const ageSec = nowSec - tsSec;\n\n    if (ageSec > maxAge) {\n        return fail(ProtocolError.TIMESTAMP_EXPIRED, `Message too old: ${ageSec}s`);\n    }\n\n    if (tsSec > nowSec + skew) {\n        return fail(\n            ProtocolError.TIMESTAMP_FUTURE,\n            `Message from future: ${tsSec - nowSec}s ahead`,\n        );\n    }\n\n    /* ── 3. Payload Size ─────────────────────────────────── */\n    if (msg.params) {\n        const paramsStr = JSON.stringify(msg.params);\n        if (paramsStr.length > MAX_PAYLOAD_BYTES) {\n            return fail(\n                ProtocolError.PAYLOAD_TOO_LARGE,\n                `Payload exceeds ${MAX_PAYLOAD_BYTES} bytes`,\n            );\n        }\n    }\n\n    /* ── 4. Nonce ────────────────────────────────────────── */\n    if (!msg.nonce) {\n        return fail(ProtocolError.NONCE_MISSING, \"Missing nonce\");\n    }\n\n    if (opts.nonceCache) {\n        if (opts.nonceCache.check(msg.nonce)) {\n            return fail(ProtocolError.NONCE_REUSED, \"Nonce already seen (replay)\");\n        }\n    }\n\n    /* ── 5. Payload Hash ─────────────────────────────────── */\n    if (msg.payload_hash) {\n        const paramsJson = JSON.stringify(msg.params ?? {});\n        const computed = await opts.crypto.sha256Hex(paramsJson);\n\n        if (computed !== msg.payload_hash) {\n            return fail(ProtocolError.HASH_MISMATCH, \"Payload hash mismatch\");\n        }\n    }\n\n    /* ── 6. Signature ────────────────────────────────────── */\n    if (!msg.signature) {\n        return fail(ProtocolError.SIGNATURE_MISSING, \"Missing signature\");\n    }\n\n    const sigResult = await verifySignatureWithFallback(\n        opts.crypto,\n        opts.activeSecret,\n        opts.previousSecret,\n        msg as Required<\n            Pick<\n                ValidatableMessage,\n                | \"version\"\n                | \"message_type\"\n                | \"device_id\"\n                | \"tenant_id\"\n                | \"timestamp\"\n                | \"message_id\"\n                | \"nonce\"\n            >\n        > &\n            Record<string, unknown>,\n        msg.signature,\n    );\n\n    if (!sigResult.valid) {\n        return fail(ProtocolError.SIGNATURE_INVALID, \"HMAC-SHA256 verification failed\");\n    }\n\n    const result = pass();\n    return { ...result, rotated: sigResult.rotated };\n}\n","/**\n * @file crypto/detect.ts\n * @description Auto-detect the best crypto provider for the current runtime.\n *\n * Copyright (c) 2026 Hestia Labs\n * SDK-License-Identifier: MIT\n */\n\nimport type { CryptoProvider } from \"./interface.js\";\n\n/**\n * Detect and return the appropriate CryptoProvider.\n *\n * Priority:\n *   1. Node.js / Bun / Deno with node:crypto → NodeCryptoProvider\n *   2. Browser / React Native with crypto.subtle → WebCryptoProvider\n *   3. Throw — no silent fallback\n */\nexport async function detectCrypto(): Promise<CryptoProvider> {\n    /* Node.js / Bun / Deno (node compat) */\n    if (typeof globalThis.process !== \"undefined\" && globalThis.process.versions?.node) {\n        const mod = await import(\"./node.js\");\n        return mod.nodeCrypto;\n    }\n\n    /* Deno native */\n    if (typeof (globalThis as Record<string, unknown>).Deno !== \"undefined\") {\n        if (typeof globalThis.crypto?.subtle !== \"undefined\") {\n            const mod = await import(\"./web.js\");\n            return mod.webCrypto;\n        }\n    }\n\n    /* Browser / React Native */\n    if (typeof globalThis.crypto?.subtle !== \"undefined\") {\n        const mod = await import(\"./web.js\");\n        return mod.webCrypto;\n    }\n\n    throw new Error(\n        \"No supported crypto provider found. \" +\n            \"Provide a CryptoProvider via config.crypto, or use \" +\n            \"hxtp-js/crypto/node or hxtp-js/crypto/web.\",\n    );\n}\n\n/**\n * Detect whether replay protection should be enabled by default.\n * Enabled in Node.js/Bun/Deno (server-side), disabled in browsers.\n */\nexport function detectReplayDefault(): boolean {\n    if (typeof globalThis.process !== \"undefined\" && globalThis.process.versions?.node) {\n        return true;\n    }\n    return false;\n}\n","/**\n * @file transport/websocket.ts\n * @description WebSocket transport for HxTP client.\n * Works in Browser, Node.js 18+ (built-in WebSocket), Bun, Deno, React Native.\n *\n * Copyright (c) 2026 Hestia Labs\n * SDK-License-Identifier: MIT\n */\n\nimport type { Transport, TransportState } from \"./interface.js\";\n\nexport type { Transport, TransportState } from \"./interface.js\";\n\nexport interface WebSocketTransportOptions {\n    /** WebSocket server URL (ws:// or wss://). */\n    readonly url: string;\n\n    /** Authentication token sent as query param. */\n    readonly token?: string;\n\n    /** Custom WebSocket protocols. */\n    readonly protocols?: string | string[];\n\n    /** Connection timeout in ms (default: 10000). */\n    readonly connectTimeoutMs?: number;\n}\n\n/**\n * WebSocket transport implementation.\n *\n * Uses the global `WebSocket` constructor available in:\n *   - All modern browsers\n *   - Node.js 21+ (global WebSocket)\n *   - Bun (global WebSocket)\n *   - Deno (global WebSocket)\n *   - React Native (global WebSocket)\n *\n * For Node.js 18-20, pass a WebSocket constructor via\n * `globalThis.WebSocket = require('ws')` or use Node 21+.\n */\nexport class WebSocketTransport implements Transport {\n    private socket: WebSocket | null = null;\n    private messageHandlers: Array<(data: string) => void> = [];\n    private closeHandlers: Array<(code: number, reason: string) => void> = [];\n    private errorHandlers: Array<(error: Error) => void> = [];\n    private _state: TransportState = \"disconnected\";\n\n    private readonly url: string;\n    private readonly protocols?: string | string[];\n    private readonly connectTimeoutMs: number;\n\n    constructor(opts: WebSocketTransportOptions) {\n        let url = opts.url;\n        if (opts.token) {\n            const sep = url.includes(\"?\") ? \"&\" : \"?\";\n            url = `${url}${sep}token=${encodeURIComponent(opts.token)}`;\n        }\n        this.url = url;\n        this.protocols = opts.protocols;\n        this.connectTimeoutMs = opts.connectTimeoutMs ?? 10_000;\n    }\n\n    get state(): TransportState {\n        return this._state;\n    }\n\n    async connect(): Promise<void> {\n        if (this._state === \"connected\") return;\n\n        this._state = \"connecting\";\n\n        return new Promise<void>((resolve, reject) => {\n            const WS = resolveWebSocket();\n            const socket = new WS(this.url, this.protocols);\n            this.socket = socket;\n\n            const timeout = setTimeout(() => {\n                socket.close();\n                this._state = \"disconnected\";\n                reject(\n                    new Error(`WebSocket connection timed out after ${this.connectTimeoutMs}ms`),\n                );\n            }, this.connectTimeoutMs);\n\n            socket.onopen = () => {\n                clearTimeout(timeout);\n                this._state = \"connected\";\n                resolve();\n            };\n\n            socket.onmessage = (event: MessageEvent) => {\n                const data = typeof event.data === \"string\" ? event.data : String(event.data);\n                for (const handler of this.messageHandlers) {\n                    handler(data);\n                }\n            };\n\n            socket.onclose = (event: CloseEvent) => {\n                clearTimeout(timeout);\n                this._state = \"disconnected\";\n                this.socket = null;\n                for (const handler of this.closeHandlers) {\n                    handler(event.code, event.reason);\n                }\n            };\n\n            socket.onerror = () => {\n                clearTimeout(timeout);\n                const err = new Error(\"WebSocket connection error\");\n                for (const handler of this.errorHandlers) {\n                    handler(err);\n                }\n                if (this._state === \"connecting\") {\n                    this._state = \"disconnected\";\n                    reject(err);\n                }\n            };\n        });\n    }\n\n    async disconnect(): Promise<void> {\n        if (!this.socket) return;\n        this.socket.close(1000, \"Client disconnect\");\n        this.socket = null;\n        this._state = \"disconnected\";\n    }\n\n    async send(data: string): Promise<void> {\n        if (!this.socket || this._state !== \"connected\") {\n            throw new Error(\"WebSocket not connected\");\n        }\n        this.socket.send(data);\n    }\n\n    onMessage(handler: (data: string) => void): void {\n        this.messageHandlers.push(handler);\n    }\n\n    onClose(handler: (code: number, reason: string) => void): void {\n        this.closeHandlers.push(handler);\n    }\n\n    onError(handler: (error: Error) => void): void {\n        this.errorHandlers.push(handler);\n    }\n}\n\n/**\n * Resolve the WebSocket constructor from the global scope.\n */\nfunction resolveWebSocket(): typeof WebSocket {\n    if (typeof globalThis.WebSocket !== \"undefined\") {\n        return globalThis.WebSocket;\n    }\n    throw new Error(\n        \"WebSocket not available. For Node.js 18-20, set globalThis.WebSocket \" +\n            \"to a WebSocket implementation (e.g., 'ws' package). Node.js 21+ has built-in WebSocket.\",\n    );\n}\n","/**\n * @file core/client.ts\n * @description HXTPClient — the public API for HxTP protocol communication.\n *\n * Features:\n *   - Signed message construction (HMAC-SHA256)\n *   - Pluggable transport (WebSocket default)\n *   - Auto-reconnect with exponential backoff\n *   - Heartbeat keepalive\n *   - Event emitter pattern (connect, disconnect, message, error)\n *   - Inbound message validation\n *\n * No global singletons. No shared mutable state. No implicit caches.\n *\n * Copyright (c) 2026 Hestia Labs\n * SDK-License-Identifier: MIT\n */\n\nimport type { CryptoProvider } from \"../crypto/interface.js\";\nimport type { Transport } from \"../transport/interface.js\";\nimport type {\n    HXTPConfig,\n    HXTPEventType,\n    HXTPMessageEvent,\n    HXTPErrorEvent,\n    HXTPEventHandler,\n    HXTPCommandPayload,\n    HXTPResponse,\n} from \"../types/client.js\";\nimport { MessageType } from \"../types/protocol.js\";\nimport { buildEnvelope } from \"./envelope.js\";\nimport { validateMessage } from \"./validation.js\";\nimport { NonceCache } from \"./nonce.js\";\nimport { detectCrypto, detectReplayDefault } from \"../crypto/detect.js\";\nimport { WebSocketTransport } from \"../transport/websocket.js\";\n\ntype EventMap = {\n    connect: void;\n    disconnect: { code: number; reason: string };\n    message: HXTPMessageEvent;\n    error: HXTPErrorEvent;\n    reconnecting: { attempt: number; delayMs: number };\n};\n\nexport class HXTPClient {\n    private readonly config: Readonly<HXTPConfig>;\n    private transport: Transport | null = null;\n    private crypto: CryptoProvider | null = null;\n    private nonceCache: NonceCache | null = null;\n    private sequence = 0;\n    private heartbeatTimer: ReturnType<typeof setInterval> | null = null;\n    private reconnectTimer: ReturnType<typeof setTimeout> | null = null;\n    private reconnectAttempt = 0;\n    private destroyed = false;\n\n    private readonly listeners = new Map<HXTPEventType, Set<HXTPEventHandler<unknown>>>();\n\n    constructor(config: HXTPConfig) {\n        if (!config.url) throw new Error(\"config.url is required\");\n        if (!config.tenantId) throw new Error(\"config.tenantId is required\");\n        if (!config.deviceId) throw new Error(\"config.deviceId is required\");\n        if (!config.secret) throw new Error(\"config.secret is required\");\n        if (config.secret.length !== 64) {\n            throw new Error(\"config.secret must be a 64-character hex string\");\n        }\n        this.config = config;\n    }\n\n    /** Connect to the server. Resolves when the connection is established. */\n    async connect(): Promise<void> {\n        if (this.destroyed) throw new Error(\"Client has been destroyed\");\n\n        this.crypto = this.config.crypto ?? (await detectCrypto());\n\n        const replayEnabled = this.config.replayProtection ?? detectReplayDefault();\n        if (replayEnabled) {\n            this.nonceCache = new NonceCache();\n        }\n\n        this.transport = this.config.transport ?? new WebSocketTransport({ url: this.config.url });\n\n        this.transport.onMessage((data) => this.handleMessage(data));\n        this.transport.onClose((code, reason) => this.handleClose(code, reason));\n        this.transport.onError((err) => this.handleError(err));\n\n        await this.transport.connect();\n        this.reconnectAttempt = 0;\n        this.startHeartbeat();\n        this.emit(\"connect\", undefined);\n    }\n\n    /** Disconnect gracefully and release resources. */\n    async disconnect(): Promise<void> {\n        this.destroyed = true;\n        this.stopHeartbeat();\n        this.stopReconnect();\n\n        if (this.transport) {\n            await this.transport.disconnect();\n            this.transport = null;\n        }\n\n        this.nonceCache?.clear();\n    }\n\n    /**\n     * Send a signed command to the server.\n     *\n     * Constructs a fully signed HxTP envelope with:\n     *   - HMAC-SHA256 signature over frozen canonical string\n     *   - SHA-256 payload hash\n     *   - Cryptographic nonce\n     *   - Monotonic sequence number\n     */\n    async sendCommand(payload: HXTPCommandPayload): Promise<HXTPResponse> {\n        if (!this.transport || this.transport.state !== \"connected\") {\n            throw new Error(\"Not connected\");\n        }\n        if (!this.crypto) {\n            throw new Error(\"Crypto provider not initialized\");\n        }\n\n        this.sequence++;\n\n        const envelope = await buildEnvelope({\n            crypto: this.crypto,\n            secretHex: this.config.secret,\n            deviceId: payload.deviceId ?? this.config.deviceId,\n            tenantId: this.config.tenantId,\n            clientId: this.config.clientId,\n            messageType: MessageType.COMMAND,\n            params: { action: payload.action, ...payload.params },\n            sequence: this.sequence,\n        });\n\n        const json = JSON.stringify(envelope);\n        await this.transport.send(json);\n\n        return {\n            ok: true,\n            messageId: envelope.message_id,\n            timestamp: envelope.timestamp,\n        };\n    }\n\n    /** Register an event listener. */\n    on<K extends HXTPEventType>(event: K, handler: HXTPEventHandler<EventMap[K]>): void {\n        if (!this.listeners.has(event)) {\n            this.listeners.set(event, new Set());\n        }\n        this.listeners.get(event)!.add(handler as HXTPEventHandler<unknown>);\n    }\n\n    /** Remove an event listener. */\n    off<K extends HXTPEventType>(event: K, handler: HXTPEventHandler<EventMap[K]>): void {\n        this.listeners.get(event)?.delete(handler as HXTPEventHandler<unknown>);\n    }\n\n    /** Whether the client is currently connected. */\n    get connected(): boolean {\n        return this.transport?.state === \"connected\";\n    }\n\n    /** Current monotonic sequence number. */\n    get currentSequence(): number {\n        return this.sequence;\n    }\n\n    /* ── Private Methods ──────────────────────────────────────────────── */\n\n    private emit<K extends HXTPEventType>(event: K, data: EventMap[K]): void {\n        const handlers = this.listeners.get(event);\n        if (!handlers) return;\n        for (const handler of handlers) {\n            try {\n                handler(data);\n            } catch {\n                /* event handlers must not throw into the client */\n            }\n        }\n    }\n\n    private async handleMessage(raw: string): Promise<void> {\n        let parsed: Record<string, unknown>;\n        try {\n            parsed = JSON.parse(raw) as Record<string, unknown>;\n        } catch {\n            this.emitError(\"PARSE_ERROR\", \"Invalid JSON message\", false);\n            return;\n        }\n\n        if (this.crypto && this.config.secret) {\n            const result = await validateMessage(parsed, {\n                crypto: this.crypto,\n                activeSecret: this.config.secret,\n                previousSecret: this.config.previousSecret,\n                nonceCache: this.nonceCache ?? undefined,\n                maxMessageAgeSec: this.config.maxMessageAgeSec,\n                timestampSkewSec: this.config.timestampSkewSec,\n            });\n\n            if (!result.ok) {\n                this.emitError(result.code, result.reason, false);\n                return;\n            }\n        }\n\n        this.emit(\"message\", {\n            raw,\n            parsed,\n            timestamp: Date.now(),\n        });\n    }\n\n    private handleClose(code: number, reason: string): void {\n        this.stopHeartbeat();\n        this.emit(\"disconnect\", { code, reason });\n\n        if (!this.destroyed && (this.config.autoReconnect ?? true)) {\n            this.scheduleReconnect();\n        }\n    }\n\n    private handleError(err: Error): void {\n        this.emitError(\"TRANSPORT_ERROR\", err.message, false);\n    }\n\n    private emitError(code: string, message: string, fatal: boolean): void {\n        this.emit(\"error\", { code, message, fatal });\n    }\n\n    private startHeartbeat(): void {\n        const interval = this.config.heartbeatIntervalMs ?? 30_000;\n        this.heartbeatTimer = setInterval(() => {\n            if (this.transport?.state === \"connected\" && this.crypto) {\n                this.sendHeartbeat().catch(() => {});\n            }\n        }, interval);\n    }\n\n    /**\n     * Send a signed heartbeat message.\n     * No unsigned messages are allowed over an authenticated channel.\n     * The heartbeat is a fully signed HxTP envelope with message_type: \"heartbeat\".\n     */\n    private async sendHeartbeat(): Promise<void> {\n        if (!this.crypto || !this.transport || this.transport.state !== \"connected\") return;\n\n        this.sequence++;\n\n        const envelope = await buildEnvelope({\n            crypto: this.crypto,\n            secretHex: this.config.secret,\n            deviceId: this.config.deviceId,\n            tenantId: this.config.tenantId,\n            clientId: this.config.clientId,\n            messageType: MessageType.HEARTBEAT,\n            params: {},\n            sequence: this.sequence,\n        });\n\n        await this.transport.send(JSON.stringify(envelope));\n    }\n\n    private stopHeartbeat(): void {\n        if (this.heartbeatTimer) {\n            clearInterval(this.heartbeatTimer);\n            this.heartbeatTimer = null;\n        }\n    }\n\n    private scheduleReconnect(): void {\n        this.reconnectAttempt++;\n        const base = this.config.reconnectDelayMs ?? 1000;\n        const max = this.config.maxReconnectDelayMs ?? 30_000;\n        const delay = Math.min(base * Math.pow(2, this.reconnectAttempt - 1), max);\n\n        this.emit(\"reconnecting\", { attempt: this.reconnectAttempt, delayMs: delay });\n\n        this.reconnectTimer = setTimeout(async () => {\n            if (this.destroyed) return;\n            try {\n                await this.transport?.connect();\n                this.reconnectAttempt = 0;\n                this.startHeartbeat();\n                this.emit(\"connect\", undefined);\n            } catch {\n                this.scheduleReconnect();\n            }\n        }, delay);\n    }\n\n    private stopReconnect(): void {\n        if (this.reconnectTimer) {\n            clearTimeout(this.reconnectTimer);\n            this.reconnectTimer = null;\n        }\n    }\n}\n","/**\n * @file core/topics.ts\n * @description MQTT topic builder matching backend Topics.ts.\n *\n * Format: hxtp/{tenantId}/device/{deviceId}/{channel}\n *\n * Copyright (c) 2026 Hestia Labs\n * SDK-License-Identifier: MIT\n */\n\nimport { Channel, type ChannelValue } from \"../types/protocol.js\";\n\n/**\n * Build an MQTT topic string for a device channel.\n */\nexport function buildTopic(tenantId: string, deviceId: string, channel: ChannelValue): string {\n    return `hxtp/${tenantId}/device/${deviceId}/${channel}`;\n}\n\n/**\n * Build a wildcard subscription topic for a channel.\n */\nexport function buildWildcard(channel: ChannelValue): string {\n    return `hxtp/+/device/+/${channel}`;\n}\n\n/**\n * Parse an MQTT topic string into components.\n * Returns null if the topic does not match HxTP format.\n */\nexport function parseTopic(\n    topic: string,\n): { tenantId: string; deviceId: string; channel: string } | null {\n    const parts = topic.split(\"/\");\n    if (parts.length !== 5 || parts[0] !== \"hxtp\" || parts[2] !== \"device\") {\n        return null;\n    }\n    return {\n        tenantId: parts[1]!,\n        deviceId: parts[3]!,\n        channel: parts[4]!,\n    };\n}\n\nexport { Channel };\n","/**\n * @file index.ts\n * @description hxtp-js — HxTP/2.2 JavaScript/TypeScript Client SDK.\n *\n * Public API surface. All exports are tree-shakeable.\n *\n * Usage:\n *   import { HXTPClient, buildCanonical, PROTOCOL_VERSION } from \"hxtp-js\";\n *\n * Copyright (c) 2026 Hestia Labs\n * SDK-License-Identifier: MIT\n */\n\n/* ── Client ──────────────────────────────────────────────────────────── */\n\nexport { HXTPClient } from \"./core/client.js\";\n\n/* ── Core Functions ──────────────────────────────────────────────────── */\n\nexport { buildCanonical, parseCanonical, validateCanonical } from \"./core/canonical.js\";\n\nexport { signMessage, verifySignature, verifySignatureWithFallback } from \"./core/signing.js\";\n\nexport { buildEnvelope } from \"./core/envelope.js\";\n\nexport { validateMessage } from \"./core/validation.js\";\n\nexport { generateNonce, NonceCache } from \"./core/nonce.js\";\n\nexport { buildTopic, buildWildcard, parseTopic } from \"./core/topics.js\";\n\n/* ── Crypto ──────────────────────────────────────────────────────────── */\n\nexport type { CryptoProvider } from \"./crypto/interface.js\";\n\nexport { constantTimeEqual, bytesToHex, hexToBytes } from \"./crypto/interface.js\";\n\nexport { detectCrypto } from \"./crypto/detect.js\";\n\n/* ── Transport ───────────────────────────────────────────────────────── */\n\nexport type { Transport, TransportState } from \"./transport/interface.js\";\n\n/* ── Types ───────────────────────────────────────────────────────────── */\n\nexport type {\n    HXTPConfig,\n    HXTPEventType,\n    HXTPMessageEvent,\n    HXTPErrorEvent,\n    HXTPEventHandler,\n    HXTPCommandPayload,\n    HXTPResponse,\n} from \"./types/client.js\";\n\nexport type {\n    HXTPMessageHeader,\n    HXTPEnvelope,\n    ValidationResult,\n    ProtocolErrorCode,\n    MessageTypeValue,\n    ChannelValue,\n} from \"./types/protocol.js\";\n\nexport {\n    PROTOCOL_VERSION,\n    CANONICAL_SEPARATOR,\n    MAX_MESSAGE_AGE_SEC,\n    TIMESTAMP_SKEW_SEC,\n    NONCE_TTL_SEC,\n    MAX_PAYLOAD_BYTES,\n    HMAC_HEX_LENGTH,\n    SHA256_HEX_LENGTH,\n    MIN_NONCE_BYTES,\n    MessageType,\n    Channel,\n    ValidationStep,\n    ProtocolError,\n} from \"./types/protocol.js\";\n"]}